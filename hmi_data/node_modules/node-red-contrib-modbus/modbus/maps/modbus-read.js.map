{"version":3,"sources":["modbus-read.js"],"names":["module","exports","RED","install","mbBasics","require","mbCore","nodes","registerType","internalDebugLog","createNode","this","name","config","topic","dataType","adr","quantity","rateUnit","delayOnStart","showStatusActivities","showErrors","startDelayTime","connection","useIOFile","ioFile","getNode","useIOForPayload","emptyMsgOnFail","verboseLogging","settings","node","logIOActivities","INPUT_TIMEOUT_MILLISECONDS","statusText","delayTimerReading","verbose","setNodeStatusWithTimeTo","timeoutOccurred","verboseWarn","logMessage","modbusClient","intervalTimerIdReading","id","server","statusValue","httpAdmin","statusOptions","sendStatus","modbusPollingRead","setNodeStatusProperties","res","search","error","status","rate","get_timeUnit_name","toString","newStatusText","fill","shape","text","onModbusConnect","onModbusInit","serialSendingAllowed","resetAllReadingTimer","initializeReadingTimer","onModbusRegister","onModbusActive","onModbusError","failureMsg","onModbusClose","onModbusBroken","reconnectOnTimeout","onModbusReadDone","sendMessage","data","errorProtocolMsg","onModbusReadError","message","reconnectTimeout","msg","resp","sendingNodeId","origMsg","response","input","mbIOCore","nameValuesFromIOFile","values","responseBuffer","valueNames","send","payload","getTimeInfo","err","functionCodeModbusRead","address","enableDeformedMessages","messageId","getObjectId","from","resetIntervalToRead","fc","clearInterval","setInterval","startIntervalReading","removeNodeListenerFromModbusClient","removeListener","calc_rateByUnit","allValueNames","onModbusQueue","on","done","deregisterForModbus","registerForModbus","post","auth","needsPermission","req","params","_"],"mappings":"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","file":"../modbus-read.js","sourcesContent":["/**\n Copyright (c) since the year 2016 Klaus Landsdorf (http://plus4nodered.com/)\n Copyright 2016 - Jason D. Harper, Argonne National Laboratory\n Copyright 2015,2016 - Mika Karaila, Valmet Automation Inc.\n Copyright 2013, 2016 IBM Corp. (node-red)\n All rights reserved.\n node-red-contrib-modbus\n\n @author <a href=\"mailto:klaus.landsdorf@bianco-royal.de\">Klaus Landsdorf</a> (Bianco Royal)\n **/\n\n/**\n * Modbus Read node.\n * @module NodeRedModbusRead\n *\n * @param RED\n */\nmodule.exports = function (RED) {\n  'use strict'\n  require('source-map-support').install()\n  const mbBasics = require('./modbus-basics')\n  const mbCore = require('./core/modbus-core')\n  const mbIOCore = require('./core/modbus-io-core')\n  const internalDebugLog = require('debug')('contribModbus:read')\n\n  function ModbusRead (config) {\n    RED.nodes.createNode(this, config)\n\n    this.name = config.name\n    this.topic = config.topic\n    this.unitid = config.unitid\n\n    this.dataType = config.dataType\n    this.adr = config.adr\n    this.quantity = config.quantity || 1\n\n    this.rate = config.rate\n    this.rateUnit = config.rateUnit\n\n    this.delayOnStart = config.delayOnStart\n    this.startDelayTime = parseInt(config.startDelayTime) || 10\n\n    this.showStatusActivities = config.showStatusActivities\n    this.showErrors = config.showErrors\n    this.showWarnings = config.showWarnings\n    this.connection = null\n\n    this.useIOFile = config.useIOFile\n    this.ioFile = RED.nodes.getNode(config.ioFile)\n    this.useIOForPayload = config.useIOForPayload\n    this.logIOActivities = config.logIOActivities\n\n    this.emptyMsgOnFail = config.emptyMsgOnFail\n    this.internalDebugLog = internalDebugLog\n    this.verboseLogging = RED.settings.verbose\n\n    const node = this\n    let timeoutOccurred = false\n    node.INPUT_TIMEOUT_MILLISECONDS = 1000\n    node.statusText = 'waiting'\n    node.delayTimerReading = false\n    node.intervalTimerIdReading = false\n    setNodeStatusWithTimeTo(node.statusText)\n    /* istanbul ignore next */\n    function verboseWarn (logMessage) {\n      if (node.verboseLogging && node.showWarnings) {\n        node.warn('Read -> ' + logMessage + ' address: ' + node.adr)\n      }\n    }\n    /* istanbul ignore next */\n    verboseWarn('open node ' + node.id)\n    const modbusClient = RED.nodes.getNode(config.server)\n    if (!modbusClient) {\n      return\n    }\n\n    node.onModbusInit = function () {\n      setNodeStatusWithTimeTo('initialized')\n    }\n\n    node.onModbusConnect = function () {\n      setNodeStatusWithTimeTo('connected')\n      node.resetAllReadingTimer()\n      node.initializeReadingTimer()\n    }\n\n    node.onModbusRegister = function () {\n      if (node.showStatusActivities) {\n        setNodeStatusWithTimeTo('registered')\n      }\n\n      if (modbusClient.serialSendingAllowed) {\n        node.resetAllReadingTimer()\n        node.initializeReadingTimer()\n        setNodeStatusWithTimeTo('connected')\n      }\n    }\n\n    node.onModbusActive = function () {\n      setNodeStatusWithTimeTo('active')\n    }\n\n    node.onModbusQueue = function () {\n      setNodeStatusWithTimeTo('queue')\n    }\n\n    node.onModbusError = function (failureMsg) {\n      setNodeStatusWithTimeTo('failure')\n      if (modbusClient.reconnectOnTimeout) {\n        node.resetAllReadingTimer()\n      }\n\n      if (node.showErrors) {\n        node.warn(failureMsg)\n      }\n    }\n\n    node.onModbusClose = function () {\n      setNodeStatusWithTimeTo('closed')\n      node.resetAllReadingTimer()\n    }\n\n    node.onModbusBroken = function () {\n      setNodeStatusWithTimeTo('broken')\n      if (modbusClient.reconnectOnTimeout) {\n        setNodeStatusWithTimeTo('reconnecting after ' + modbusClient.reconnectTimeout + ' msec.')\n        node.resetAllReadingTimer()\n      }\n    }\n\n    node.onModbusReadDone = function (resp, msg) {\n      if (node.showStatusActivities) {\n        setNodeStatusWithTimeTo('reading done')\n      }\n      sendMessage(resp.data, resp, msg)\n    }\n\n    node.errorProtocolMsg = function (err, msg) {\n      if (node.showErrors) {\n        mbBasics.logMsgError(node, err, msg)\n      }\n    }\n\n    node.onModbusReadError = function (err, msg) {\n      node.internalDebugLog(err.message)\n      node.errorProtocolMsg(err, msg)\n      mbBasics.sendEmptyMsgOnFail(node, err, msg)\n      mbBasics.setModbusError(node, modbusClient, err, msg)\n    }\n\n    node.modbusPollingRead = function () {\n      if (!modbusClient.client) {\n        setNodeStatusWithTimeTo('waiting')\n        return\n      }\n\n      if (node.showWarnings && config.enableDeformedMessages) {\n        verboseWarn('Deformed Message support is enabled')\n      }\n\n      const msg = {\n        topic: node.topic || 'polling',\n        from: node.name,\n        payload: {\n          unitid: node.unitid,\n          fc: mbCore.functionCodeModbusRead(node.dataType),\n          address: node.adr,\n          quantity: node.quantity,\n          enableDeformedMessages: config.enableDeformedMessages,\n          messageId: mbCore.getObjectId()\n        }\n      }\n\n      if (node.showStatusActivities) {\n        setNodeStatusWithTimeTo('polling')\n      }\n\n      modbusClient.emit('readModbus', msg, node.onModbusReadDone, node.onModbusReadError)\n    }\n\n    node.resetDelayTimerToRead = function (node) {\n      if (node.delayTimerReading) {\n        /* istanbul ignore next */\n        verboseWarn('resetDelayTimerToRead node ' + node.id)\n        clearTimeout(node.delayTimerReading)\n      }\n      node.delayTimerReading = null\n    }\n\n    node.resetIntervalToRead = function (node) {\n      if (node.intervalTimerIdReading) {\n        /* istanbul ignore next */\n        verboseWarn('resetIntervalToRead node ' + node.id)\n        clearInterval(node.intervalTimerIdReading)\n      }\n      node.intervalTimerIdReading = null\n    }\n\n    node.resetAllReadingTimer = function () {\n      node.resetDelayTimerToRead(node)\n      node.resetIntervalToRead(node)\n    }\n\n    node.resetAllReadingTimer()\n\n    node.startIntervalReading = function () {\n      if (!node.intervalTimerIdReading) {\n        /* istanbul ignore next */\n        verboseWarn('startIntervalReading node ' + node.id)\n        node.intervalTimerIdReading = setInterval(node.modbusPollingRead, mbBasics.calc_rateByUnit(node.rate, node.rateUnit))\n      }\n    }\n\n    node.initializeReadingTimer = function () {\n      node.resetAllReadingTimer()\n      if (node.delayOnStart) {\n        /* istanbul ignore next */\n        verboseWarn('initializeReadingTimer delay timer node ' + node.id)\n        node.delayTimerReading = setTimeout(node.startIntervalReading, node.INPUT_TIMEOUT_MILLISECONDS * node.startDelayTime)\n      } else {\n        node.startIntervalReading()\n      }\n    }\n\n    node.removeNodeListenerFromModbusClient = function () {\n      modbusClient.removeListener('mbinit', node.onModbusInit)\n      modbusClient.removeListener('mbqueue', node.onModbusQueue)\n      modbusClient.removeListener('mbconnected', node.onModbusConnect)\n      modbusClient.removeListener('mbactive', node.onModbusActive)\n      modbusClient.removeListener('mberror', node.onModbusError)\n      modbusClient.removeListener('mbclosed', node.onModbusClose)\n      modbusClient.removeListener('mbbroken', node.onModbusBroken)\n      modbusClient.removeListener('mbregister', node.onModbusRegister)\n      modbusClient.removeListener('mbderegister', node.onModbusClose)\n    }\n\n    this.on('close', function (done) {\n      node.resetAllReadingTimer()\n      node.removeNodeListenerFromModbusClient()\n      setNodeStatusWithTimeTo('closed')\n      /* istanbul ignore next */\n      verboseWarn('close node ' + node.id)\n      modbusClient.deregisterForModbus(node.id, done)\n    })\n\n    function sendMessage (values, response, msg) {\n      const topic = msg.topic || node.topic\n      if (node.useIOFile && node.ioFile.lastUpdatedAt) {\n        if (node.logIOActivities) {\n          mbIOCore.internalDebug('node.adr:' + node.adr + ' node.quantity:' + node.quantity)\n        }\n\n        const allValueNames = mbIOCore.nameValuesFromIOFile(node, msg, values, response, node.adr)\n        const valueNames = mbIOCore.filterValueNames(node, allValueNames, mbCore.functionCodeModbusRead(node.dataType), node.adr, node.quantity)\n\n        const origMsg = {\n          topic,\n          responseBuffer: response,\n          input: msg,\n          sendingNodeId: node.id\n        }\n\n        if (node.useIOForPayload) {\n          origMsg.payload = valueNames\n          origMsg.values = values\n        } else {\n          origMsg.payload = values\n          origMsg.valueNames = valueNames\n        }\n\n        node.send([\n          origMsg,\n          {\n            topic,\n            payload: response,\n            values,\n            input: msg,\n            valueNames,\n            sendingNodeId: node.id\n          }])\n      } else {\n        node.send([\n          {\n            topic,\n            payload: values,\n            responseBuffer: response,\n            input: msg,\n            sendingNodeId: node.id\n          },\n          {\n            topic,\n            payload: response,\n            values,\n            input: msg,\n            sendingNodeId: node.id\n          }\n        ])\n      }\n    }\n\n    function setNodeStatusWithTimeTo (statusValue) {\n      if (statusValue === 'polling' && timeoutOccurred) {\n        return\n      }\n\n      const statusOptions = mbBasics.setNodeStatusProperties(statusValue, node.showStatusActivities)\n      const statusText = node.statusText\n\n      if (statusValue.search('active') !== -1 || statusValue === 'polling') {\n        const newStatusText = statusOptions.status + getTimeInfo()\n        timeoutOccurred = false\n        if (newStatusText !== statusText) {\n          node.status({\n            fill: statusOptions.fill,\n            shape: statusOptions.shape,\n            text: newStatusText\n          })\n        }\n      } else {\n        const newStatusText = statusOptions.status\n        if (newStatusText !== statusText) {\n          node.status({\n            fill: statusOptions.fill,\n            shape: statusOptions.shape,\n            text: newStatusText\n          })\n        }\n      }\n    }\n\n    function getTimeInfo () {\n      return ' ( ' + node.rate + ' ' + mbBasics.get_timeUnit_name(node.rateUnit) + ' ) '\n    }\n\n    if (node.showStatusActivities) {\n      modbusClient.on('mbinit', node.onModbusInit)\n      modbusClient.on('mbqueue', node.onModbusQueue)\n    }\n\n    modbusClient.on('mbconnected', node.onModbusConnect)\n    modbusClient.on('mbactive', node.onModbusActive)\n    modbusClient.on('mberror', node.onModbusError)\n    modbusClient.on('mbclosed', node.onModbusClose)\n    modbusClient.on('mbbroken', node.onModbusBroken)\n    modbusClient.on('mbregister', node.onModbusRegister)\n    modbusClient.on('mbderegister', node.onModbusClose)\n\n    modbusClient.registerForModbus(node)\n  }\n\n  RED.nodes.registerType('modbus-read', ModbusRead)\n\n  RED.httpAdmin.post('/modbus/read/inject/:id', RED.auth.needsPermission('modbus.inject.write'), function (req, res) {\n    const node = RED.nodes.getNode(req.params.id)\n\n    if (node) {\n      try {\n        node.modbusPollingRead()\n        res.sendStatus(200)\n      } catch (err) {\n        res.sendStatus(500)\n        node.error(RED._('modbusinject.failed', { error: err.toString() }))\n      }\n    } else {\n      res.sendStatus(404)\n    }\n  })\n}\n"]}