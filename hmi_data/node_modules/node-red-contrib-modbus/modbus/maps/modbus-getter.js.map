{"version":3,"sources":["modbus-getter.js"],"names":["module","exports","RED","install","mbBasics","require","mbCore","nodes","registerType","config","internalDebugLog","createNode","this","name","dataType","adr","quantity","showErrors","showStatusActivities","showWarnings","msgThruput","connection","useIOFile","useIOForPayload","logIOActivities","emptyMsgOnFail","keepMsgProperties","verboseLogging","settings","delayOnStart","enableDeformedMessages","startDelayTime","parseInt","node","bufferMessageList","INPUT_TIMEOUT_MILLISECONDS","delayOccured","setNodeStatusTo","modbusClient","getNode","inputDelayTimer","initModbusClientEvents","server","verbose","verboseWarn","logMessage","registerForModbus","onModbusCommandDone","resp","msg","onModbusCommandError","err","data","message","sendEmptyMsgOnFail","setModbusError","logMsgError","buildNewMessageObject","messageId","getObjectId","errorProtocolMsg","origMsg","id","payload","functionCodeModbusRead","address","topic","value","warn","isReadyForInput","client","isActive","isNotReadyForInput","resetInputDelayTimer","clearTimeout","initializeInputDelayTimer","setTimeout","isInactive","assign","on","newMsg","origMsgInput","buildNewMessage","setNodeDefaultStatus","ModbusGetter","done","removeAllListeners","clear","deregisterForModbus"],"mappings":"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","file":"../modbus-getter.js","sourcesContent":["/**\n Copyright (c) since the year 2016 Klaus Landsdorf (http://plus4nodered.com/)\n All rights reserved.\n node-red-contrib-modbus - The BSD 3-Clause License\n\n @author <a href=\"mailto:klaus.landsdorf@bianco-royal.de\">Klaus Landsdorf</a> (Bianco Royal)\n */\n\n/**\n * Modbus Getter node.\n * @module NodeRedModbusGetter\n *\n * @param RED\n */\nmodule.exports = function (RED) {\n  'use strict'\n  require('source-map-support').install()\n  const mbBasics = require('./modbus-basics')\n  const mbCore = require('./core/modbus-core')\n  const mbIOCore = require('./core/modbus-io-core')\n  const internalDebugLog = require('debug')('contribModbus:getter')\n\n  function ModbusGetter (config) {\n    RED.nodes.createNode(this, config)\n\n    this.name = config.name\n    this.unitid = config.unitid\n\n    this.dataType = config.dataType\n    this.adr = config.adr\n    this.quantity = config.quantity\n\n    this.showStatusActivities = config.showStatusActivities\n    this.showErrors = config.showErrors\n    this.showWarnings = config.showWarnings\n    this.msgThruput = config.msgThruput\n    this.connection = null\n\n    this.useIOFile = config.useIOFile\n    this.ioFile = RED.nodes.getNode(config.ioFile)\n    this.useIOForPayload = config.useIOForPayload\n    this.logIOActivities = config.logIOActivities\n\n    this.emptyMsgOnFail = config.emptyMsgOnFail\n    this.keepMsgProperties = config.keepMsgProperties\n    this.internalDebugLog = internalDebugLog\n    this.verboseLogging = RED.settings.verbose\n\n    this.delayOnStart = config.delayOnStart\n    this.enableDeformedMessages = config.enableDeformedMessages\n    this.startDelayTime = parseInt(config.startDelayTime) || 10\n\n    const node = this\n    node.bufferMessageList = new Map()\n    node.INPUT_TIMEOUT_MILLISECONDS = 1000\n    node.delayOccured = false\n    node.inputDelayTimer = null\n\n    mbBasics.setNodeStatusTo('waiting', node)\n\n    const modbusClient = RED.nodes.getNode(config.server)\n    if (!modbusClient) {\n      return\n    }\n    modbusClient.registerForModbus(node)\n    mbBasics.initModbusClientEvents(node, modbusClient)\n\n    node.onModbusCommandDone = function (resp, msg) {\n      if (node.showStatusActivities) {\n        mbBasics.setNodeStatusTo('reading done', node)\n      }\n      node.send(mbIOCore.buildMessageWithIO(node, resp.data, resp, msg))\n      node.emit('modbusGetterNodeDone')\n    }\n\n    node.errorProtocolMsg = function (err, msg) {\n      if (node.showErrors) {\n        mbBasics.logMsgError(node, err, msg)\n      }\n    }\n\n    node.onModbusCommandError = function (err, msg) {\n      node.internalDebugLog(err.message)\n      const origMsg = mbCore.getOriginalMessage(node.bufferMessageList, msg)\n      node.errorProtocolMsg(err, origMsg)\n      mbBasics.sendEmptyMsgOnFail(node, err, msg)\n      mbBasics.setModbusError(node, modbusClient, err, origMsg)\n      node.emit('modbusGetterNodeError')\n    }\n\n    if (node.showWarnings && node.enableDeformedMessages) {\n      node.warn('Deformed Message support is enabled')\n    }\n\n    node.buildNewMessageObject = function (node, msg) {\n      const messageId = mbCore.getObjectId()\n      return {\n        topic: msg.topic || node.id,\n        messageId,\n        payload: {\n          value: msg.payload.value || msg.payload,\n          unitid: node.unitid,\n          fc: mbCore.functionCodeModbusRead(node.dataType),\n          address: node.adr,\n          quantity: node.quantity,\n          enableDeformedMessages: node.enableDeformedMessages,\n          messageId\n        }\n      }\n    }\n\n    /* istanbul ignore next */\n    function verboseWarn (logMessage) {\n      if (RED.settings.verbose && node.showWarnings) {\n        node.warn('Getter -> ' + logMessage)\n      }\n    }\n\n    node.isReadyForInput = function () {\n      return (modbusClient.client && modbusClient.isActive() && node.delayOccured)\n    }\n\n    node.isNotReadyForInput = function () {\n      return !node.isReadyForInput()\n    }\n\n    node.resetInputDelayTimer = function () {\n      if (node.inputDelayTimer) {\n        /* istanbul ignore next */\n        verboseWarn('reset input delay timer node ' + node.id)\n        clearTimeout(node.inputDelayTimer)\n      }\n      node.inputDelayTimer = null\n      node.delayOccured = false\n    }\n\n    node.initializeInputDelayTimer = function () {\n      node.resetInputDelayTimer()\n      if (node.delayOnStart) {\n        /* istanbul ignore next */\n        verboseWarn('initialize input delay timer node ' + node.id)\n        node.inputDelayTimer = setTimeout(() => {\n          node.delayOccured = true\n        }, node.INPUT_TIMEOUT_MILLISECONDS * node.startDelayTime)\n      } else {\n        node.delayOccured = true\n      }\n    }\n\n    node.initializeInputDelayTimer()\n\n    node.on('input', function (msg) {\n      /* istanbul ignore next */\n      if (mbBasics.invalidPayloadIn(msg)) {\n        verboseWarn('Invalid message on input.')\n        return\n      }\n      /* istanbul ignore next */\n      if (node.isNotReadyForInput()) {\n        verboseWarn('Inject while node is not ready for input.')\n        return\n      }\n      /* istanbul ignore next */\n      if (modbusClient.isInactive()) {\n        verboseWarn('You sent an input to inactive client. Please use initial delay on start or send data more slowly.')\n        return\n      }\n\n      const origMsgInput = Object.assign({}, msg) // keep it origin\n      try {\n        const newMsg = node.buildNewMessageObject(node, origMsgInput)\n        node.bufferMessageList.set(newMsg.messageId, mbBasics.buildNewMessage(node.keepMsgProperties, origMsgInput, newMsg))\n        modbusClient.emit('readModbus', newMsg, node.onModbusCommandDone, node.onModbusCommandError)\n\n        if (node.showStatusActivities) {\n          mbBasics.setNodeStatusTo(modbusClient.actualServiceState, node)\n        }\n      } catch (err) {\n        /* istanbul ignore next */\n        node.errorProtocolMsg(err, origMsgInput)\n        /* istanbul ignore next */\n        mbBasics.sendEmptyMsgOnFail(node, err, origMsgInput)\n      }\n    })\n\n    node.on('close', function (done) {\n      mbBasics.setNodeStatusTo('closed', node)\n      node.resetInputDelayTimer()\n      node.removeAllListeners()\n      node.bufferMessageList.clear()\n      modbusClient.deregisterForModbus(node.id, done)\n    })\n\n    if (!node.showStatusActivities) {\n      mbBasics.setNodeDefaultStatus(node)\n    }\n  }\n\n  RED.nodes.registerType('modbus-getter', ModbusGetter)\n}\n"]}