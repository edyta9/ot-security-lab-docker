{"version":3,"sources":["modbus-flex-getter.js"],"names":["module","exports","RED","install","mbBasics","require","mbCore","nodes","registerType","config","internalDebugLog","createNode","this","name","showStatusActivities","showErrors","showWarnings","useIOFile","ioFile","getNode","useIOForPayload","logIOActivities","keepMsgProperties","verboseLogging","delayOnStart","settings","startDelayTime","parseInt","node","enableDeformedMessages","bufferMessageList","Map","modbusClient","delayOccured","inputDelayTimer","setNodeStatusTo","initModbusClientEvents","INPUT_TIMEOUT_MILLISECONDS","verbose","logMessage","mbIOCore","buildMessageWithIO","emit","errorProtocolMsg","err","msg","logMsgError","onModbusReadError","resp","data","sendEmptyMsgOnFail","setModbusError","parse","payload","message","address","quantity","prepareMsg","Number","isInteger","JSON","isValid","fc","unitid","error","isValidModbusMsg","warn","buildNewMessageObject","messageId","getObjectId","value","isReadyForInput","isNotReadyForInput","topic","resetInputDelayTimer","id","verboseWarn","clearTimeout","emptyMsgOnFail","initializeInputDelayTimer","client","isActive","invalidPayloadIn","isInactive","messageQueue","processNextMessage","setTimeout","inputMsg","on","deregisterForModbus","push","length","shift","origMsgInput","Object","assign","newMsg","set","buildNewMessage","onModbusReadDone","Error","done","clear","setNodeDefaultStatus"],"mappings":"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","file":"../modbus-flex-getter.js","sourcesContent":["/**\n Copyright (c) since the year 2016 Klaus Landsdorf (http://plus4nodered.com/)\n All rights reserved.\n node-red-contrib-modbus - The BSD 3-Clause License\n\n @author <a href=\"mailto:klaus.landsdorf@bianco-royal.de\">Klaus Landsdorf</a> (Bianco Royal)\n */\n\n/**\n * Modbus flexible Getter node.\n * @module NodeRedModbusFlexGetter\n *\n * @param RED\n */\nmodule.exports = function (RED) {\n  'use strict'\n  require('source-map-support').install()\n  const mbBasics = require('./modbus-basics')\n  const mbCore = require('./core/modbus-core')\n  const mbIOCore = require('./core/modbus-io-core')\n  const internalDebugLog = require('debug')('contribModbus:flex:getter')\n\n  function ModbusFlexGetter (config) {\n    RED.nodes.createNode(this, config)\n\n    this.name = config.name\n    this.showStatusActivities = config.showStatusActivities\n    this.showErrors = config.showErrors\n    this.showWarnings = config.showWarnings\n    this.connection = null\n\n    this.useIOFile = config.useIOFile\n    this.ioFile = RED.nodes.getNode(config.ioFile)\n    this.useIOForPayload = config.useIOForPayload\n    this.logIOActivities = config.logIOActivities\n\n    this.emptyMsgOnFail = config.emptyMsgOnFail\n    this.keepMsgProperties = config.keepMsgProperties\n    this.internalDebugLog = internalDebugLog\n    this.verboseLogging = RED.settings.verbose\n\n    this.delayOnStart = config.delayOnStart\n    this.enableDeformedMessages = config.enableDeformedMessages\n    this.startDelayTime = parseInt(config.startDelayTime) || 10\n\n    const node = this\n    node.bufferMessageList = new Map()\n    node.INPUT_TIMEOUT_MILLISECONDS = 1000\n    node.delayOccured = false\n    node.inputDelayTimer = null\n\n    mbBasics.setNodeStatusTo('waiting', node)\n\n    const modbusClient = RED.nodes.getNode(config.server)\n\n    if (!modbusClient) {\n      return\n    }\n    modbusClient.registerForModbus(node)\n    mbBasics.initModbusClientEvents(node, modbusClient)\n\n    node.onModbusReadDone = function (resp, msg) {\n      if (node.showStatusActivities) {\n        mbBasics.setNodeStatusTo('reading done', node)\n      }\n\n      node.send(mbIOCore.buildMessageWithIO(node, resp.data, resp, msg))\n      node.emit('modbusFlexGetterNodeDone')\n    }\n\n    node.errorProtocolMsg = function (err, msg) {\n      if (node.showErrors) {\n        mbBasics.logMsgError(node, err, msg)\n      }\n    }\n\n    node.onModbusReadError = function (err, msg) {\n      node.internalDebugLog(err.message)\n      const origMsg = mbCore.getOriginalMessage(node.bufferMessageList, msg)\n      node.errorProtocolMsg(err, origMsg)\n      mbBasics.sendEmptyMsgOnFail(node, err, origMsg)\n      mbBasics.setModbusError(node, modbusClient, err, origMsg)\n      node.emit('modbusFlexGetterNodeError')\n    }\n\n    node.prepareMsg = function (msg) {\n      if (typeof msg.payload === 'string') {\n        msg.payload = JSON.parse(msg.payload)\n      }\n\n      msg.payload.fc = parseInt(msg.payload.fc) || 3\n      msg.payload.unitid = parseInt(msg.payload.unitid)\n      msg.payload.address = parseInt(msg.payload.address) || 0\n      msg.payload.quantity = parseInt(msg.payload.quantity) || 1\n\n      return msg\n    }\n\n    node.isValidModbusMsg = function (msg) {\n      let isValid = true\n\n      if (!(Number.isInteger(msg.payload.fc) &&\n        msg.payload.fc >= 1 &&\n        msg.payload.fc <= 4)) {\n        node.error('FC Not Valid', msg)\n        isValid &= false\n      }\n\n      if (isValid &&\n        !(Number.isInteger(msg.payload.address) &&\n          msg.payload.address >= 0 &&\n          msg.payload.address <= 65535)) {\n        node.error('Address Not Valid', msg)\n        isValid &= false\n      }\n\n      if (isValid &&\n        !(Number.isInteger(msg.payload.quantity) &&\n          msg.payload.quantity >= 1 &&\n          msg.payload.quantity <= 65535)) {\n        node.error('Quantity Not Valid', msg)\n        isValid &= false\n      }\n      return isValid\n    }\n\n    if (node.showWarnings && node.enableDeformedMessages) {\n      node.warn('Deformed Message support is enabled')\n    }\n\n    node.buildNewMessageObject = function (node, msg) {\n      const messageId = mbCore.getObjectId()\n      return {\n        topic: msg.topic || node.id,\n        messageId,\n        payload: {\n          value: msg.payload.value || msg.value,\n          unitid: msg.payload.unitid,\n          fc: msg.payload.fc,\n          address: msg.payload.address,\n          quantity: msg.payload.quantity,\n          emptyMsgOnFail: node.emptyMsgOnFail,\n          keepMsgProperties: node.keepMsgProperties,\n          enableDeformedMessages: node.enableDeformedMessages,\n          messageId\n        }\n      }\n    }\n    /* istanbul ignore next */\n    function verboseWarn (logMessage) {\n      if (RED.settings.verbose && node.showWarnings) {\n        node.warn('Flex-Getter -> ' + logMessage)\n      }\n    }\n\n    node.isReadyForInput = function () {\n      return (modbusClient.client && modbusClient.isActive() && node.delayOccured)\n    }\n\n    node.isNotReadyForInput = function () {\n      return !node.isReadyForInput()\n    }\n\n    node.resetInputDelayTimer = function () {\n      if (node.inputDelayTimer) {\n        /* istanbul ignore next */\n        verboseWarn('reset input delay timer node ' + node.id)\n        clearTimeout(node.inputDelayTimer)\n      }\n      node.inputDelayTimer = null\n      node.delayOccured = false\n    }\n\n    node.initializeInputDelayTimer = function () {\n      node.resetInputDelayTimer()\n      if (node.delayOnStart) {\n        /* istanbul ignore next */\n        verboseWarn('initialize input delay timer node ' + node.id)\n        node.inputDelayTimer = setTimeout(() => {\n          node.delayOccured = true\n        }, node.INPUT_TIMEOUT_MILLISECONDS * node.startDelayTime)\n      } else {\n        node.delayOccured = true\n      }\n    }\n\n    node.initializeInputDelayTimer()\n\n    // Add a queue to store incoming messages\n    const messageQueue = []\n\n    node.on('input', function (msg) {\n      if (mbBasics.invalidPayloadIn(msg)) {\n        /* istanbul ignore next */\n        verboseWarn('Invalid message on input.')\n        return\n      }\n      if (node.isNotReadyForInput()) {\n        /* istanbul ignore next */\n        verboseWarn('Inject while node is not ready for input.')\n        return\n      }\n      if (modbusClient.isInactive()) {\n        /* istanbul ignore next */\n        verboseWarn('You sent an input to inactive client. Please use initial delay on start or send data more slowly.')\n        return\n      }\n\n      messageQueue.push(msg)\n      processNextMessage()\n    })\n\n    function processNextMessage () {\n      if (messageQueue.length === 0) {\n        node.emit('modbusFlexGetterNodeDone')\n        return\n      }\n      const msg = messageQueue.shift()\n      const origMsgInput = Object.assign({}, msg)\n      try {\n        const inputMsg = node.prepareMsg(origMsgInput)\n        if (node.isValidModbusMsg(inputMsg)) {\n          const newMsg = node.buildNewMessageObject(node, inputMsg)\n          node.bufferMessageList.set(newMsg.messageId, mbBasics.buildNewMessage(node.keepMsgProperties, inputMsg, newMsg))\n          modbusClient.emit('readModbus', newMsg, node.onModbusReadDone, node.onModbusReadError)\n        } else {\n          node.errorProtocolMsg(new Error('Invalid Modbus message'), origMsgInput)\n          mbBasics.sendEmptyMsgOnFail(node, new Error('Invalid Modbus message'), origMsgInput)\n        }\n      } catch (err) {\n        node.errorProtocolMsg(err, origMsgInput)\n        mbBasics.sendEmptyMsgOnFail(node, err, origMsgInput)\n      }\n      processNextMessage()\n    }\n    node.on('close', function (done) {\n      node.resetInputDelayTimer()\n      mbBasics.setNodeStatusTo('closed', node)\n      node.bufferMessageList.clear()\n      modbusClient.deregisterForModbus(node.id, done)\n    })\n\n    if (!node.showStatusActivities) {\n      mbBasics.setNodeDefaultStatus(node)\n    }\n  }\n\n  RED.nodes.registerType('modbus-flex-getter', ModbusFlexGetter)\n}\n"]}